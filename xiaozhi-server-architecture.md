# xiaozhi-server 双服务器架构图

## 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                    xiaozhi-server 主进程                        │
│                         (app.py)                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────┐         ┌─────────────────────────┐    │
│  │   WebSocketServer   │         │   SimpleHttpServer      │    │
│  │   (端口: 8000)      │         │   (端口: 8003)          │    │
│  │                     │         │                         │    │
│  │ 功能：                │         │ 功能：                   │    │
│  │ • 实时音频通信        │         │ • 设备发现服务           │    │
│  │ • AI对话处理         │         │ • 视觉分析接口           │    │
│  │ • WebSocket协议升级   │         │ • OTA配置下发           │    │
│  └─────────────────────┘         └─────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
```

## 详细连接流程图

```
ESP32设备启动流程:
┌─────────────┐
│   ESP32     │
│   设备      │
└──────┬──────┘
       │ 1. 开机后首先需要知道服务器在哪里
       ▼
┌─────────────────────────────────────┐
│  HTTP GET/POST: /xiaozhi/ota/       │◄─── 硬编码或配置的HTTP地址
│  (SimpleHttpServer:8003)            │     (比如: http://192.168.1.100:8003)
│                                     │
│  返回JSON:                          │
│  {                                  │
│    "websocket": {                   │
│      "url": "ws://192.168.1.100:8000/xiaozhi/v1/"  ◄─── 重点！
│    },                               │
│    "firmware": {...},               │
│    "server_time": {...}             │
│  }                                  │
└─────────────────┬───────────────────┘
                  │ 2. 获取到WebSocket地址
                  ▼
┌─────────────────────────────────────┐
│  WebSocket连接建立                   │
│  ws://192.168.1.100:8000/xiaozhi/v1/│
│  (WebSocketServer:8000)             │
│                                     │
│  连接过程:                          │
│  • HTTP升级握手请求                  │
│  • Connection: upgrade             │
│  • 协议切换成功                      │
│  • 开始音频数据传输                  │
└─────────────────────────────────────┘
```

## 客户端应用连接流程图

```
手机APP/网页客户端:
┌─────────────────┐
│   客户端应用     │
└────────┬────────┘
         │ 直接连接WebSocket
         ▼ (不需要经过OTA)
┌─────────────────────────────────────┐
│  直接WebSocket连接                   │
│  ws://192.168.1.100:8000/xiaozhi/v1/│
│  (WebSocketServer:8000)             │
│                                     │
│  • 发送文本消息                      │
│  • 发送音频数据                      │
│  • 接收AI回复                       │
└─────────────────────────────────────┘
```

## 两种"升级"对比表

| 类型 | WebSocket升级 | OTA升级 |
|------|--------------|---------|
| **位置** | WebSocketServer:8000 | SimpleHttpServer:8003 |
| **升级什么** | HTTP协议→WebSocket协议 | ESP32设备获取服务器地址 |
| **谁发起** | 任何WebSocket客户端 | ESP32硬件设备 |
| **何时发生** | 每次建立WebSocket连接时 | 设备启动时或需要重新发现服务器时 |
| **传输内容** | 协议握手信息 | 服务器配置JSON |
| **结果** | 建立实时双向通信 | 设备知道去哪里连接 |

## 为什么需要这样设计？

```
问题: ESP32设备怎么知道服务器的WebSocket地址？

解决方案:
┌─────────────────┐    HTTP请求     ┌──────────────────┐
│   ESP32设备     │ ──────────────► │  OTA接口         │
│                 │                 │  (固定HTTP地址)   │
│ 1. 我在192.168.1.50  ◄──────────── │                  │
│ 2. 服务器在哪里？     JSON响应      │ "WebSocket在     │
│ 3. 好的，连接到       │                 │  192.168.1.100   │
│    WebSocket去！     │                 │  :8000端口"      │
└─────────────────┘                 └──────────────────┘
                │                            ▲
                │ WebSocket连接               │
                ▼                            │
┌─────────────────────────────────────────────┴────┐
│           WebSocket服务器                        │
│         开始实时音频AI对话                        │
└─────────────────────────────────────────────────┘
```

## 关键理解点

1. **ESP32不知道服务器IP**：设备启动时不知道服务器在哪，需要"问一下"
2. **OTA是发现服务**：告诉设备"真正的通信地址在这里"
3. **WebSocket是工作服务**：处理实际的AI对话和音频数据
4. **两个端口分工明确**：8003负责"找到我"，8000负责"和我对话"

## 你的疑问：HTTP地址也会变，怎么办？

这确实是个"鸡生蛋蛋生鸡"的问题！解决方案是：

### 方案一：固件编译时硬编码
```
ESP32固件编译时：
┌─────────────────────────────────────┐
│ xiaozhi-esp32/main/Kconfig.projbuild │
│                                     │
│ config OTA_URL                      │
│   default "http://192.168.1.100:8003/xiaozhi/ota/"  ◄─── 编译时固定
└─────────────────────────────────────┘
```

### 方案二：设备配网时手动配置
```
ESP32配网模式：
┌─────────────────┐    手动输入OTA地址    ┌─────────────────┐
│   用户操作      │ ─────────────────────► │   ESP32设备     │
│                 │                       │                 │
│ 1. 进入配网模式   │                       │ 保存OTA地址到    │
│ 2. 高级选项      │                       │ 非易失存储器     │
│ 3. 输入OTA地址   │                       │                 │
└─────────────────┘                       └─────────────────┘
```

### 实际解决策略

```
层级固定策略:

┌─────────────────────────────────────────────────────────────┐
│                   解决"循环依赖"                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ Level 1: 固定入口 (解决根本问题)                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ • ESP32固件编译时硬编码默认OTA地址                        │ │
│ │ • 用户可以通过配网界面手动修改OTA地址                     │ │
│ │ • 这个地址一旦设置就相对固定（除非手动修改）              │ │
│ └─────────────────────────────────────────────────────────┘ │
│                            │                               │
│                            ▼                               │
│ Level 2: 动态发现 (解决灵活性问题)                           │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ • 通过固定的OTA接口获取当前WebSocket地址                  │ │
│ │ • WebSocket地址可以随时变化（IP变化、端口变化）           │ │
│ │ │ • 网络环境变化（家里→公司→手机热点）                    │ │
│ │ │ • 服务器迁移（新服务器、不同端口）                      │ │
│ │ │ • 负载均衡（多个WebSocket实例）                        │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 为什么这样设计有意义？

1. **HTTP地址相对稳定**：通常部署在固定服务器上，端口8003也相对固定
2. **WebSocket地址经常变化**：
   - 可能有多个WebSocket实例做负载均衡
   - 可能因为网络变化需要切换端口
   - 可能因为服务器迁移需要更新IP
3. **分层解决**：用相对稳定的地址去获取频繁变化的地址

这样设计的好处是：
- ESP32可以动态发现服务器（IP可能变化）
- 分离关注点：发现服务 vs 通信服务
- 便于调试：可以单独测试每个服务
- **最重要**：只需要在固件中固定一个相对稳定的HTTP地址，就能动态获取所有其他地址
