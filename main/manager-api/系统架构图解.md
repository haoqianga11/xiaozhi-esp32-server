# Manager-API 系统架构图解

## 📝 文档说明
本文档包含了 Manager-API 项目的系统架构和数据流程的 ASCII 图解，帮助初学者理解项目结构。

---

## 🏗️ 系统架构全貌图

```text
┌─────────────────────────────────────────────────────────────────┐
│                        HTTP 请求层                              │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    SysParamsController                         │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  GET  /admin/params/page     ── 分页查询              │   │
│  │  GET  /admin/params/{id}     ── 获取单个              │   │
│  │  POST /admin/params          ── 新增参数              │   │
│  │  PUT  /admin/params          ── 更新参数              │   │
│  │  POST /admin/params/delete   ── 删除参数              │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                   SysParamsService                             │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  业务逻辑处理：                                        │   │
│  │  • 数据验证 (validateParamValue)                      │   │
│  │  • 类型检查 (string/number/boolean/json/array)        │   │
│  │  • 缓存管理 (Redis读写)                               │   │
│  │  • 事务控制 (@Transactional)                         │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                          │                │
                          ▼                ▼
              ┌─────────────────┐  ┌─────────────────┐
              │   Redis 缓存     │  │   MySQL 数据库   │
              │                 │  │                 │
              │ 参数码 → 参数值  │  │  sys_params 表  │
              │ (快速查询)      │  │  (持久化存储)    │
              └─────────────────┘  └─────────────────┘
```

---

## 🔄 数据处理流程图

```text
                        ┌─── 客户端请求 ───┐
                        │                 │
                        ▼                 │
            ┌─────────────────────┐       │
            │    HTTP Request     │       │
            │  (JSON 格式数据)     │       │
            └─────────────────────┘       │
                        │                 │
                        ▼                 │
            ┌─────────────────────┐       │
            │   Controller 层     │       │ 
            │ • 接收请求           │       │
            │ • 权限检查           │       │
            │ • 参数校验           │       │
            └─────────────────────┘       │
                        │                 │
                        ▼                 │
            ┌─────────────────────┐       │
            │    Service 层       │       │
            │ • 业务逻辑处理       │       │
            │ • 数据类型验证       │       │
            │ • 缓存策略管理       │       │
            └─────────────────────┘       │
                   │           │          │
                   ▼           ▼          │
        ┌─────────────┐  ┌─────────────┐  │
        │   Redis     │  │   MySQL     │  │
        │   缓存      │  │   数据库    │  │
        │ (临时存储)  │  │ (永久存储)  │  │
        └─────────────┘  └─────────────┘  │
                   │           │          │
                   └─────┬─────┘          │
                         ▼                │
            ┌─────────────────────┐       │
            │     响应数据        │       │
            │ Entity → DTO → JSON │       │
            └─────────────────────┘       │
                        │                 │
                        ▼                 │
            ┌─────────────────────┐       │
            │   HTTP Response     │       │
            │   (返回给客户端)    │ ──────┘
            └─────────────────────┘
```

---

## 📊 数据传输对象关系图

```text
┌──────────────────── 数据流转过程 ────────────────────┐
│                                                     │
│  前端 JSON                Controller              Service             Database
│      ↓                      ↓                      ↓                    ↓
│ ┌─────────┐  ──转换──→  ┌─────────┐  ──转换──→  ┌─────────┐  ──存储──→  ┌─────────┐
│ │ 请求数据 │             │   DTO   │             │ Entity  │             │  表记录  │
│ │  {      │             │ (传输)  │             │ (实体)  │             │ (数据行) │
│ │  "id":1 │             │         │             │         │             │         │
│ │  }      │             │         │             │         │             │         │
│ └─────────┘             └─────────┘             └─────────┘             └─────────┘
│      ↑                      ↑                      ↑                    ↑
│ ┌─────────┐  ←──转换───  ┌─────────┐  ←──转换───  ┌─────────┐  ←──查询───  ┌─────────┘
│ │ 响应数据 │             │   DTO   │             │ Entity  │
│ │ (JSON)  │             │ (传输)  │             │ (实体)  │
│ └─────────┘             └─────────┘             └─────────┘
│
└─────────────────────────────────────────────────────────┘

数据对象的职责：
• DTO (Data Transfer Object)：专门用于前后端数据传输
• Entity：映射数据库表结构，用于 ORM 操作  
• JSON：前端和后端之间的数据交换格式
```

---

## 🔐 权限和缓存策略图

```text
┌──────────────── 请求处理完整流程 ────────────────┐
│                                                 │
│          HTTP 请求                              │
│             │                                   │
│             ▼                                   │
│    ┌─────────────────┐                         │
│    │   权限检查       │                         │
│    │ @RequiresPerms  │                         │
│    │ "sys:role:      │                         │
│    │  superAdmin"    │                         │
│    └─────────────────┘                         │
│             │                                   │
│         权限通过 ✓                              │
│             │                                   │
│             ▼                                   │
│    ┌─────────────────┐                         │
│    │   业务处理       │                         │
│    └─────────────────┘                         │
│             │                                   │
│             ▼                                   │
│    ┌─────────────────┐    ┌─────────────────┐  │
│    │   查询缓存       │ ──→│   缓存命中      │  │
│    │   Redis.get()   │    │   返回数据 ✓    │  │
│    └─────────────────┘    └─────────────────┘  │
│             │                                   │
│         缓存未命中                              │
│             │                                   │
│             ▼                                   │
│    ┌─────────────────┐                         │
│    │   查询数据库     │                         │
│    │   MySQL.query() │                         │
│    └─────────────────┘                         │
│             │                                   │
│             ▼                                   │
│    ┌─────────────────┐                         │
│    │   更新缓存       │                         │
│    │   Redis.set()   │                         │
│    └─────────────────┘                         │
│             │                                   │
│             ▼                                   │
│    ┌─────────────────┐                         │
│    │   返回结果       │                         │
│    └─────────────────┘                         │
│                                                 │
└─────────────────────────────────────────────────┘
```

---

## 🎯 参数验证流程图

```text
┌─────── 参数验证 validateParamValue() ───────┐
│                                            │
│              输入参数                       │
│         ┌──────────────┐                   │
│         │ SysParamsDTO │                   │
│         │ • paramCode  │                   │
│         │ • paramValue │                   │
│         │ • valueType  │                   │
│         └──────────────┘                   │
│                │                           │
│                ▼                           │
│         根据 valueType 分支：               │
│                                            │
│    ┌───────┬───────┬───────┬───────┬──────┐│
│    ▼       ▼       ▼       ▼       ▼      ││
│ string   array  number  boolean   json    ││
│   │       │       │       │       │      ││
│   │       │       ▼       ▼       ▼      ││
│   │       │   Double.   "true"   JSON     ││
│   │       │   parse()   "false"  parse()  ││
│   │       │      │       │       │       ││
│   │       │      ▼       ▼       ▼       ││
│   ▼       ▼   ┌─────┐ ┌─────┐ ┌─────┐    ││
│  通过    通过  │验证 │ │验证 │ │验证 │    ││
│               │成功✓│ │成功✓│ │成功✓│    ││
│               └─────┘ └─────┘ └─────┘    ││
│                  │       │       │       ││
│                  ▼       ▼       ▼       ││
│            抛出异常 ErrorCode.PARAM_XXX    ││
│                     (如果验证失败)        ││
└────────────────────────────────────────────┘
```

---

## 📚 核心概念总结

### 🔍 三层架构
- **Controller**: 接收HTTP请求，处理路由
- **Service**: 业务逻辑处理，数据验证
- **DAO/Entity**: 数据访问，数据库操作

### 🔄 数据流动
- **请求**: JSON → DTO → Entity → Database
- **响应**: Database → Entity → DTO → JSON

### ⚡ 性能优化
- **Redis 缓存**: 加速查询操作
- **事务控制**: 保证数据一致性
- **批量操作**: 提高数据库操作效率

### 🔐 安全机制
- **权限控制**: `@RequiresPermissions` 注解
- **数据验证**: 参数类型和格式校验
- **异常处理**: 统一的错误处理机制

---

## 📝 学习建议

1. **先理解架构图** - 掌握整体结构
2. **跟踪数据流程** - 理解数据如何流转
3. **关注缓存策略** - 学习性能优化方法
4. **理解验证逻辑** - 掌握数据安全处理

---

*创建时间: 2025-09-01*  
*项目: xiaozhi-esp32-server Manager-API*  
*学习阶段: 第一阶段 - 项目结构理解*
