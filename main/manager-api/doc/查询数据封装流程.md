# Spring Boot 查询数据封装流程详解

## 🔍 完整查询流程 ASCII 图

```text
                    Spring Boot 查询数据封装完整流程
┌─────────────────────────────────────────────────────────────────────────────┐
│                          HTTP GET /xiaozhi/admin/params/123                  │
└─────────────────────────┬───────────────────────────────────────────────────┘
                          │ 1. HTTP请求到达
                          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                   📍 Controller Layer (控制层)                             │
├─────────────────────────────────────────────────────────────────────────────┤
│  @GetMapping("{id}")                                                        │
│  public Result<SysParamsDTO> get(@PathVariable("id") Long id) {             │
│      SysParamsDTO data = sysParamsService.get(id); // 👈 调用Service        │
│      return new Result<SysParamsDTO>().ok(data);   // 👈 封装返回           │
│  }                                                                          │
│                                                                             │
│  📥 输入: HTTP请求参数 id=123                                               │
│  📤 输出: Result<SysParamsDTO> (JSON格式)                                   │
└─────────────────────────┬───────────────────────────────────────────────────┘
                          │ 2. 调用Service层
                          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    📍 Service Layer (业务层)                               │
├─────────────────────────────────────────────────────────────────────────────┤
│  @Override                                                                  │
│  public SysParamsDTO get(Long id) {                                         │
│      SysParamsEntity entity = baseDao.selectById(id); // 👈 调用DAO         │
│      return ConvertUtils.sourceToTarget(entity, SysParamsDTO.class);        │
│      // 👆 Entity转换为DTO                                                  │
│  }                                                                          │
│                                                                             │
│  📥 输入: Long id = 123                                                     │
│  📤 输出: SysParamsDTO                                                      │
└─────────────────────────┬───────────────────────────────────────────────────┘
                          │ 3. 调用DAO层
                          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                     📍 DAO Layer (数据访问层)                              │
├─────────────────────────────────────────────────────────────────────────────┤
│  @Mapper                                                                    │
│  public interface SysParamsDao extends BaseDao<SysParamsEntity> {           │
│      // MyBatis-Plus 自动生成 CRUD 方法                                    │
│      // selectById() 继承自 BaseDao                                         │
│  }                                                                          │
│                                                                             │
│  📥 输入: Long id = 123                                                     │
│  📤 输出: SysParamsEntity                                                   │
└─────────────────────────┬───────────────────────────────────────────────────┘
                          │ 4. 执行SQL查询
                          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    📍 Database Layer (数据库层)                            │
├─────────────────────────────────────────────────────────────────────────────┤
│  AUTO-GENERATED SQL:                                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ SELECT id, param_code, param_value, value_type,                    │   │
│  │        param_type, remark, creator, create_date,                   │   │
│  │        updater, update_date                                         │   │
│  │ FROM sys_params                                                     │   │
│  │ WHERE id = 123                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  📥 输入: SQL查询 WHERE id = 123                                            │
│  📤 输出: 数据库记录行                                                      │
└─────────────────────────┬───────────────────────────────────────────────────┘
                          │ 5. 返回数据库记录
                          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    📍 MyBatis 结果映射                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│  数据库记录 → Java对象映射:                                                 │
│  ┌─────────────────────┐     映射     ┌─────────────────────────────┐       │
│  │ 数据库字段          │    ──────►   │ Java Entity字段             │       │
│  ├─────────────────────┤              ├─────────────────────────────┤       │
│  │ id = 123            │              │ private Long id = 123L      │       │
│  │ param_code = "app"  │              │ private String paramCode    │       │
│  │ param_value = "v1"  │              │ private String paramValue   │       │
│  │ value_type = "str"  │              │ private String valueType    │       │
│  │ remark = "应用参数" │              │ private String remark       │       │
│  │ create_date = ...   │              │ private Date createDate     │       │
│  └─────────────────────┘              └─────────────────────────────┘       │
│                                                                             │
│  📥 输入: 数据库原始记录                                                    │
│  📤 输出: SysParamsEntity 对象                                              │
└─────────────────────────┬───────────────────────────────────────────────────┘
                          │ 6. Entity返回到Service
                          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    📍 Entity → DTO 转换                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│  ConvertUtils.sourceToTarget(entity, SysParamsDTO.class);                  │
│                                                                             │
│  ┌─────────────────────────┐    转换    ┌──────────────────────────┐       │
│  │ SysParamsEntity        │   ──────►   │ SysParamsDTO             │       │
│  ├─────────────────────────┤             ├──────────────────────────┤       │
│  │ id = 123L              │             │ id = 123L                │       │
│  │ paramCode = "app"      │             │ paramCode = "app"        │       │
│  │ paramValue = "v1"      │             │ paramValue = "v1"        │       │
│  │ valueType = "string"   │             │ valueType = "string"     │       │
│  │ paramType = 0          │ 🚫过滤掉     │ (不包含paramType)        │       │
│  │ remark = "应用参数"    │             │ remark = "应用参数"      │       │
│  │ creator = 1L           │ 🚫过滤掉     │ (不包含creator)          │       │
│  │ createDate = ...       │             │ createDate = ...         │       │
│  │ updater = 1L           │ 🚫过滤掉     │ (不包含updater)          │       │
│  │ updateDate = ...       │             │ updateDate = ...         │       │
│  └─────────────────────────┘             └──────────────────────────┘       │
│                                                                             │
│  📥 输入: SysParamsEntity (包含所有数据库字段)                              │
│  📤 输出: SysParamsDTO (只包含对外暴露的字段)                               │
└─────────────────────────┬───────────────────────────────────────────────────┘
                          │ 7. DTO返回到Controller
                          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    📍 Result 统一封装                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│  new Result<SysParamsDTO>().ok(data);                                      │
│                                                                             │
│  ┌──────────────────────┐     封装     ┌────────────────────────────┐       │
│  │ SysParamsDTO        │    ──────►    │ Result<SysParamsDTO>       │       │
│  ├──────────────────────┤               ├────────────────────────────┤       │
│  │ id = 123L           │               │ code = 0 (成功)           │       │
│  │ paramCode = "app"   │               │ msg = "success"            │       │
│  │ paramValue = "v1"   │               │ data = {                   │       │
│  │ valueType = "string"│               │   id: 123,                 │       │
│  │ remark = "应用参数" │               │   paramCode: "app",        │       │
│  │ createDate = ...    │               │   paramValue: "v1",        │       │
│  │ updateDate = ...    │               │   valueType: "string",     │       │
│  └──────────────────────┘               │   remark: "应用参数",      │       │
│                                         │   createDate: "2023...",   │       │
│                                         │   updateDate: "2023..."    │       │
│                                         │ }                          │       │
│                                         └────────────────────────────┘       │
│                                                                             │
│  📥 输入: SysParamsDTO                                                      │
│  📤 输出: Result<SysParamsDTO>                                              │
└─────────────────────────┬───────────────────────────────────────────────────┘
                          │ 8. Spring Boot自动序列化
                          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    📍 Jackson JSON 序列化                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│  Spring Boot 自动将 Result<SysParamsDTO> 转换为 JSON                       │
│                                                                             │
│  ┌────────────────────────────┐   序列化   ┌──────────────────────────┐     │
│  │ Result<SysParamsDTO>       │  ────────► │ HTTP Response Body       │     │
│  │ Java对象                   │            │ JSON字符串               │     │
│  └────────────────────────────┘            └──────────────────────────┘     │
│                                                                             │
│  最终 JSON 输出:                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ {                                                                   │   │
│  │   "code": 0,                                                        │   │
│  │   "msg": "success",                                                 │   │
│  │   "data": {                                                         │   │
│  │     "id": 123,                                                      │   │
│  │     "paramCode": "app",                                             │   │
│  │     "paramValue": "v1",                                             │   │
│  │     "valueType": "string",                                          │   │
│  │     "remark": "应用参数",                                           │   │
│  │     "createDate": "2023-12-25 10:30:45",                          │   │
│  │     "updateDate": "2023-12-25 12:15:20"                           │   │
│  │   }                                                                 │   │
│  │ }                                                                   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  📥 输入: Java Result对象                                                   │
│  📤 输出: JSON字符串 + HTTP响应头                                           │
└─────────────────────────┬───────────────────────────────────────────────────┘
                          │ 9. 返回HTTP响应
                          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          📍 HTTP Response                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│  HTTP/1.1 200 OK                                                           │
│  Content-Type: application/json;charset=UTF-8                              │
│  Content-Length: 245                                                       │
│                                                                             │
│  {                                                                          │
│    "code": 0,                                                               │
│    "msg": "success",                                                        │
│    "data": {                                                                │
│      "id": 123,                                                             │
│      "paramCode": "app",                                                    │
│      "paramValue": "v1",                                                    │
│      "valueType": "string",                                                 │
│      "remark": "应用参数",                                                  │
│      "createDate": "2023-12-25 10:30:45",                                 │
│      "updateDate": "2023-12-25 12:15:20"                                  │
│    }                                                                        │
│  }                                                                          │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 🔄 数据转换关键步骤详解

### 1. Entity vs DTO 的区别

```java
// SysParamsEntity (数据库实体) - 包含所有数据库字段
@TableName("sys_params")
public class SysParamsEntity extends BaseEntity {
    private String paramCode;     // 对应 param_code 字段
    private String paramValue;    // 对应 param_value 字段  
    private String valueType;     // 对应 value_type 字段
    private Integer paramType;    // 🔒 内部字段，不对外暴露
    private String remark;        
    private Long creator;         // 🔒 内部字段，不对外暴露
    private Date createDate;      
    private Long updater;         // 🔒 内部字段，不对外暴露
    private Date updateDate;      
}

// SysParamsDTO (数据传输对象) - 只包含对外暴露的字段
public class SysParamsDTO {
    private Long id;
    private String paramCode;
    private String paramValue; 
    private String valueType;
    // 🚫 没有 paramType - 内部字段不暴露
    private String remark;
    // 🚫 没有 creator - 创建者不暴露给前端
    private Date createDate;      // ✅ 创建时间可以暴露
    // 🚫 没有 updater - 更新者不暴露给前端  
    private Date updateDate;      // ✅ 更新时间可以暴露
}
```

### 2. ConvertUtils 转换原理

```java
// 转换工具类的核心逻辑
public static <T> T sourceToTarget(Object source, Class<T> target) {
    if (source == null) {
        return null;
    }
    
    try {
        T targetInstance = target.newInstance();
        
        // 通过反射复制同名字段
        BeanUtils.copyProperties(source, targetInstance);
        
        return targetInstance;
    } catch (Exception e) {
        throw new RuntimeException("对象转换失败", e);
    }
}
```

### 3. Result 统一封装格式

```java
// Result 类的结构
public class Result<T> {
    private int code = 0;      // 0=成功, 非0=失败
    private String msg = "success";  // 响应消息
    private T data;            // 实际数据 (泛型)
    
    public Result<T> ok(T data) {
        this.data = data;
        return this;
    }
    
    public Result<T> error(String msg) {
        this.code = 500;
        this.msg = msg;
        return this;
    }
}
```

### 4. Jackson 自动序列化规则

```java
// Jackson 注解控制序列化行为
public class SysParamsDTO {
    @JsonProperty(access = JsonProperty.Access.READ_ONLY)  // 只读，不参与反序列化
    private Date createDate;
    
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")  // 日期格式化
    private Date updateDate;
    
    @JsonIgnore  // 完全忽略此字段
    private String internalField;
}
```

## 💡 关键理解点

### 🎯 为什么需要 Entity → DTO 转换？

1. **安全性**: Entity包含数据库所有字段(包括密码等敏感信息)，DTO只暴露需要的字段
2. **解耦**: 数据库结构变化不影响API接口
3. **版本控制**: 不同版本API可以使用不同DTO
4. **性能**: 减少网络传输数据量

### 🎯 为什么需要 Result 统一封装？

1. **标准化**: 所有API都返回统一格式 {code, msg, data}
2. **错误处理**: 统一的错误码和错误信息
3. **前端解析**: 前端可以统一处理所有API响应
4. **扩展性**: 方便添加分页信息、权限信息等

### 🎯 Spring Boot 的"自动化"体现在哪？

1. **自动SQL生成**: MyBatis-Plus根据方法名生成SQL
2. **自动对象映射**: 数据库字段自动映射到Java对象
3. **自动JSON序列化**: Java对象自动转换为JSON
4. **自动HTTP处理**: 自动解析请求参数，自动设置响应头

这就是Spring Boot将数据库数据封装成HTTP响应的完整流程！每一步都有明确的职责和转换规则。
